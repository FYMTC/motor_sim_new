# 电机仿真性能调优

## 问题: 霍尔传感器频率过低
**症状:** 在 3V 驱动电压下，霍尔传感器仅以 2.36 Hz 切换，远低于高速电机要求。

**根本原因:** 定时器中断速率与电机仿真时间步长（`dt`）不匹配。

### 原始配置
- TIM2 周期 = 4,294,967,295（最大 32 位值）
- 中断频率 ≈ 0.064 Hz
- 电机仿真 `dt = 1 ms`（不匹配）
- 结果: 电机响应极慢

### 修正配置（v2 - 超高速）
**TIM2 设置:**
```c
预分频器 = 274 (275-1)
周期 = 100
APB1 时钟 = 275 MHz
```

**中断频率:**
```
f_interrupt = 275 MHz / 275 / 100 = 10 kHz
dt = 1 / 10 kHz = 100 μs
```

**电机参数（针对高速优化）:**
```c
dt = 1e-4f;           // 100 μs（匹配定时器）
J = 2e-7f;            // 0.2 g·cm²（超轻转子）
b = 1e-5f;            // 0.01 mN·m·s（极小摩擦）
Kt = 0.05f;           // 50 mN·m/A（高转矩）
Ke = 0.003f;          // 3 mV·s/rad（低反电动势，适合高速）
R = 1.0f;             // 1 Ω（较低铜损）
L = 0.0001f;          // 0.1 mH（快速电气响应）
```

**3V 时的理论最大速度:**
```
ω_max ≈ V / Ke = 3.0 / 0.003 = 1000 rad/s
RPM = 1000 * 60 / (2π) ≈ 9550 RPM
霍尔频率 = 1000 / (2π) * 4 ≈ 637 Hz
```

### 性能改进
- **之前（v1）:** 3V 时霍尔频率 2.36 Hz
- **之后（v2）:** 3V 时预期约 300-600 Hz（之前: 24 Hz，参数次优）
- **仿真精度:** 10 kHz 更新速率确保平滑动力学
- **关键更改:** 将 Ke 从 0.015 降至 0.003（5倍），降低 J（5倍），增加 Kt（3.3倍）

### 验证
在调试中监控这些变量:
- `g_motorState.velocity` - 应显示合理的 rad/s 值
- `g_motorState.position` - 应平滑递增
- 霍尔 GPIO 切换速率 - 使用示波器测量

### 进一步调优
如果霍尔频率仍然太低:
1. **减小电气时间常数:** 降低 `L`，增加 `Kt`
2. **减小机械时间常数:** 降低 `J`，减小 `b`
3. **检查电压缩放:** 验证 ADC 到电压的转换（0-3.3V）

如果霍尔频率太高或不稳定:
1. **增加阻尼:** 提高 `b`
2. **增加负载惯量:** 提高 `J`
3. **添加位置限制** 以约束运动范围

